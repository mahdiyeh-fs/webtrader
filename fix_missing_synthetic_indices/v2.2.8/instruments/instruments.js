define(["exports","jquery","websockets/binary_websockets","navigation/menu","charts/chartWindow","../common/marketUtils","jquery-growl","common/util"],function(e,t,a,n,r,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getSpecificMarketData=e.isMarketDataPresent=e.getMarketData=e.init=void 0;var i=o(t),u=o(a),m=o(n),l=o(r);function o(e){return e&&e.__esModule?e:{default:e}}function d(){return new Promise(function(e){u.default.cached.authorize().then(function(){u.default.cached.send({active_symbols:"brief"}).then(function(e){local_storage.set("active_symbols",e.active_symbols);var r=[];_(e.active_symbols).groupBy("market").map(function(e){var t=filterRestrictedSymbols(e),a=_.head(t),n={name:a.market,display_name:a.market_display_name};return n.submarkets=_(t).groupBy("submarket").map(function(e){var t=_.head(e),a={name:t.submarket,display_name:t.submarket_display_name};return a.instruments=_.map(e,function(e){return r.push(e.symbol),{symbol:e.symbol,display_name:e.display_name}}),a}).value(),n}).value();f=y.map(function(e){return{display_name:e.display_name,name:e.name,submarkets:e.submarkets.map(function(e){return{display_name:e.display_name,instruments:e.instruments.filter(function(e){return-1!==r.indexOf(e.symbol)})}}).filter(function(e){return 0!==e.instruments.length})}}).filter(function(e){return 0!==e.submarkets.length}),f=(0,s.getSortedMarketSubmarkets)(f);var t=(0,i.default)("#nav-menu").find(".instruments");t.find("> ul").remove(),m.default.refreshMenu(t,f,c)})}).catch(function(){u.default.cached.send({active_symbols:"brief"}).then(function(e){local_storage.set("active_symbols",e.active_symbols);var r=[];_(e.active_symbols).groupBy("market").map(function(e){var t=filterRestrictedSymbols(e),a=_.head(t),n={name:a.market,display_name:a.market_display_name};return n.submarkets=_(t).groupBy("submarket").map(function(e){var t=_.head(e),a={name:t.submarket,display_name:t.submarket_display_name};return a.instruments=_.map(e,function(e){return r.push(e.symbol),{symbol:e.symbol,display_name:e.display_name}}),a}).value(),n}).value();f=y.map(function(e){return{display_name:e.display_name,name:e.name,submarkets:e.submarkets.map(function(e){return{display_name:e.display_name,instruments:e.instruments.filter(function(e){return-1!==r.indexOf(e.symbol)})}}).filter(function(e){return 0!==e.instruments.length})}}).filter(function(e){return 0!==e.submarkets.length}),f=(0,s.getSortedMarketSubmarkets)(f);var t=(0,i.default)("#nav-menu").find(".instruments");t.find("> ul").remove(),m.default.refreshMenu(t,f,c)})})})}function c(e,t){l.default.addNewWindow({instrumentCode:e,instrumentName:t,timePeriod:"1d",type:"candlestick"})}var f=[],y=[],b=e.init=function(){return u.default.cached.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(e){return y=m.default.extractChartableMarkets(e),d(),u.default.events.on("login",d),u.default.events.on("logout",d),y})},p=e.getMarketData=function(){return f},k=e.isMarketDataPresent=function(a,e){var n=!1;e=e||f;var r=this;return i.default.each(e,function(e,t){return t.submarkets||t.instruments?n=r.isMarketDataPresent(a,t.submarkets||t.instruments):i.default.trim(t.display_name)==i.default.trim(a)&&(n=!0),!n}),n},v=e.getSpecificMarketData=function(a,e){var n={};e=e||f;var r=this;return i.default.each(e,function(e,t){return t.submarkets||t.instruments?n=r.getSpecificMarketData(a,t.submarkets||t.instruments):i.default.trim(t.display_name)==i.default.trim(a)&&(n=t),i.default.isEmptyObject(n)}),n};e.default={init:b,getMarketData:p,isMarketDataPresent:k,getSpecificMarketData:v}});