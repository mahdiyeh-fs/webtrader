define(["exports","jquery","../windows/windows","../common/rivetsExtra","lodash","text!./copytrade.html","../common/common","websockets/binary_websockets","websockets/validateToken","../instruments/instruments","css!./copytrade.css","../common/util"],function(e,t,a,n,o,r,s,i,d,l){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.init=void 0;var c=h(t),u=h(a),f=h(n),g=h(o),_=h(r),m=h(i),p=h(d);function h(e){return e&&e.__esModule?e:{default:e}}function k(){return"copyTrade_"+T}function y(e,t,a){return{open:!1,started:a,disableStart:!1,loginid:t,yourCopySettings:{copy_start:e,min_trade_stake:10,max_trade_stake:100,assets:g.default.cloneDeep(E),trade_types:g.default.cloneDeep(C)}}}var T=local_storage.get("oauth")[0].id,w=s.trade_types,v={INVALID_STAKE_LIMIT:"Min trade stake should be lower than max trade stake.".i18n(),TOKEN_ALREADY_ADDED:"Token already added".i18n(),ENTER_VALID_TOKEN:"Enter a valid trader token".i18n(),REFRESH_FAILED:"Refresh failed".i18n()},C=w.slice(0,2).map(function(e){return e.api_code}),S=g.default.debounce(function(e){var t=g.default.cloneDeep(e);delete t.searchToken.disable,local_storage.set(k(),t)},50),b=null,E=null;(0,l.init)().then(function(e){b=g.default.flatten(e.map(function(e){var t=e.display_name;return e.submarkets.map(function(e){return{displayName:t+" - "+e.display_name,instruments:e.instruments}})}));var n=[];e.forEach(function(e){e.submarkets.forEach(function(e){e.instruments.forEach(function(e){var t=e.symbol,a=e.display_name;n.push({code:t,name:a})})})}),x.masterAssetList=n,x.groupedAssets=b,E=n.filter(function(e){return"R_10"===e.code}).map(function(e){return e.code})});function A(n,o,r,e){var s=3<arguments.length&&void 0!==e&&e;return new Promise(function(a,t){m.default.send({copytrading_statistics:1,trader_id:n}).then(function(e){if(e.copytrading_statistics){var t=g.default.find(r.traderTokens,function(e){return e.yourCopySettings&&e.yourCopySettings.copy_start===o});t?(g.default.merge(t.traderStatistics,e.copytrading_statistics),s&&(t.started=!0)):r.traderTokens.push(g.default.merge({traderStatistics:e.copytrading_statistics},y(o,n,s)))}S(r),a()}).catch(function(e){t(e)})})}var D=null,R=null,x={masterAssetList:[],masterTradeTypeList:g.default.cloneDeep(w),groupedAssets:[],is_loading:!0,allowCopy:{allow_copiers:0,onAllowCopyChangeCopierCellClick:function(){return x.onChangeCopytradeSettings(0)},onAllowCopyChangeTraderCellClick:function(){return x.onChangeCopytradeSettings(1)}},onChangeCopytradeSettings:g.default.debounce(function(t){x.allowCopy.allow_copiers!==t&&(x.is_loading=!0,m.default.send({set_settings:1,allow_copiers:t}).then(function(e){x.is_loading=!1,x.allowCopy.allow_copiers=t}).catch(function(e){x.is_loading=!1,c.default.growl.error({message:e.message})}))},250),onOpenChange:function(e){x.traderTokens[e].open=!x.traderTokens[e].open},onStartedChange:function(t){if(x.traderTokens[t].disableStart=!0,!x.traderTokens[t].started){var e=local_storage.get(k());if(e){var a=e.traderTokens[t];if(a){var n={};g.default.merge(n,x.traderTokens[t],a),x.traderTokens.splice(t,1),g.default.defer(function(){x.traderTokens.splice(t,0,n);var e=g.default.cloneDeep(n.yourCopySettings);e.min_trade_stake||delete e.min_trade_stake,e.max_trade_stake||delete e.max_trade_stake,(!e.assets||e.assets.length<=0)&&delete e.assets,(!e.trade_types||e.trade_types.length<=0)&&delete e.trade_types,m.default.send(e).then(function(){n.disableStart=!1,n.started=!0,L("#max_trade_stake","#min_trade_stake"),S(x)}).catch(function(e){c.default.growl.error({message:e.message}),n.disableStart=!1,L("#max_trade_stake","#min_trade_stake"),S(x)})})}}}else m.default.send({copy_stop:x.traderTokens[t].yourCopySettings.copy_start}).then(function(){x.traderTokens[t].disableStart=!1,x.traderTokens[t].started=!1,S(x)}).catch(function(e){c.default.growl.error({message:e.message}),x.traderTokens[t].disableStart=!1,S(x)})},onRemove:function(e){var t=x.traderTokens[e];x.traderTokens.splice(e,1),S(x),m.default.send({copy_stop:t.yourCopySettings.copy_start}).catch(function(e){})},onRefresh:function(e){var t=x.traderTokens[e],a=t.loginid,n=t.yourCopySettings.copy_start;a&&n&&(t.disableRefresh=!0,A(a,n,x).then(function(){t.disableRefresh=!1}).catch(function(e){c.default.growl.error({message:v.REFRESH_FAILED}),t.disableRefresh=!1}))},onMinTradeChange:function(e,t){x.formatAndSetTradeStake(e,t,"min_trade_stake")},onMaxTradeChange:function(e,t){x.formatAndSetTradeStake(e,t,"max_trade_stake")},formatAndSetTradeStake:function(e,t,a){var n=(0,c.default)(e.target).data("index"),o=e.target.value,r=!g.default.isNil(o)&&o.match(/0*(\d+\.?\d{0,2})/);t.traderTokens[n].yourCopySettings[a]=r?r[1]:""},onUpdateYourSettings:function(e){var t,a;t=x.traderTokens[e].yourCopySettings,a=t.min_trade_stake,+t.max_trade_stake<+a?c.default.growl.error({message:v.INVALID_STAKE_LIMIT}):(S(x),c.default.growl.notice({message:"Updated successfully"}))},searchToken:{token:"",onTokenChange:function(e,t){return t.searchToken.token=e.target.value},disable:!1,onKeyDown:function(e,t){13===e.keyCode&&t.searchToken.addToken(e,t)},addToken:function(e,t){t.searchToken.token?g.default.some(x.traderTokens,function(e){return e.yourCopySettings.copy_start===t.searchToken.token})?c.default.growl.error({message:v.TOKEN_ALREADY_ADDED}):(t.searchToken.disable=!0,(0,p.default)(t.searchToken.token).then(function(e){if(!e)throw new Error("Invalid token");A(e.loginid,t.searchToken.token,t).then(function(){t.searchToken.token="",t.searchToken.disable=!1}).catch(function(e){t.searchToken.disable=!1,c.default.growl.error({message:e.message})})}).catch(function(e){c.default.growl.error({message:e.message}),t.searchToken.disable=!1})):c.default.growl.error({message:v.ENTER_VALID_TOKEN})}},traderTokens:[],openTokenMgmt:function(){return(0,c.default)("li.account ul a.token-management").click()}},I=function(){m.default.cached.send({copytrading_list:1}).then(function(e){var t=e.copytrading_list.traders;t.length||(x.is_loading=!1);try{var a=!0,n=!1,o=void 0;try{for(var r,s=t[Symbol.iterator]();!(a=(r=s.next()).done);a=!0){var i=r.value,d=i.loginid,l=i.token;A(d,l,x,!0).then(function(){x.is_loading=!1}).catch(function(e){x.is_loading=!1,c.default.growl.error({message:v.REFRESH_FAILED})})}}catch(e){n=!0,o=e}finally{try{!a&&s.return&&s.return()}finally{if(n)throw o}}}catch(e){x.is_loading=!1,c.default.growl.error({message:v.REFRESH_FAILED})}}).catch(function(e){x.is_loading=!1,c.default.growl.error({message:e.message})})},L=function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];if(0<t.length){var n=t.join(", ");(0,c.default)(n).keypress(function(e){(e.which<48||57<e.which)&&8!==e.which&&46!==e.which&&e.preventDefault()})}},N=e.init=function(e){e.click(function(){var e;D?D.moveToTop():(e=(0,c.default)(_.default).i18n(),R=f.default.bind(e[0],x),(D=u.default.createBlankWindow(e,{title:"Copy Trading".i18n(),resizable:!1,collapsable:!1,minimizable:!0,maximizable:!1,modal:!1,width:600,open:function(){x.is_loading=!0,m.default.cached.authorize().then(function(e){e.authorize.loginid===local_storage.get("authorize").loginid&&m.default.cached.send({get_settings:1}).then(function(e){x.allowCopy.allow_copiers=e.get_settings.allow_copiers,e.get_settings.allow_copiers?x.is_loading=!1:I()}).catch(function(e){x.is_loading=!1,c.default.growl.error({message:e.message})})})},close:function(){R&&R.unbind(),D&&D.dialog("destroy").remove(),R=D=null,x.traderTokens=[]},"data-authorized":"true"})).track({module_id:"copyTrade",is_unique:!0,data:null}),D.dialog("open"),L("#max_trade_stake","#min_trade_stake"))}),m.default.events.on("logout",function(){var e=k();e&&local_storage.get(e)&&local_storage.remove(e)})};e.default={init:N}});