{"version":3,"sources":["../../../../src/instruments/instruments.es6"],"names":["refresh_active_symbols","Promise","resolve","liveapi","cached","authorize","then","send","active_symbols","data","local_storage","set","active_markets","_","groupBy","map","symbols","filtered_symbols","filterRestrictedSymbols","sym","head","market","name","display_name","market_display_name","submarkets","submarket","submarket_display_name","instruments","push","symbol","value","markets","chartable_markets","m","sm","filter","ins","indexOf","length","find","remove","menu","refreshMenu","onMenuItemClick","catch","displayName","chartWindow","addNewWindow","instrumentCode","instrumentName","timePeriod","type","init","trading_times","Date","toISOString","slice","extractChartableMarkets","events","on","getMarketData","isMarketDataPresent","marketDataDisplayName","marketData","present","instrumentObj","$","each","key","trim","getSpecificMarketData","isEmptyObject"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAQA,aAASA,sBAAT,GAAkC;AAC9B,eAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAa;AAC5BC,wCACKC,MADL,CAEKC,SAFL,GAGKC,IAHL,CAGU,YAAM;AACRH,4CACKC,MADL,CAEKG,IAFL,CAEU,EAAEC,gBAAgB,OAAlB,EAFV,EAGKF,IAHL,CAGU,UAAUG,IAAV,EAAgB;AAClBC,kCAAcC,GAAd,CAAkB,gBAAlB,EAAoCF,KAAKD,cAAzC;AACA,wBAAMA,iBAAiB,EAAvB;AACA,wBAAMI,iBAAiBC,EAAEJ,KAAKD,cAAP,EAAuBM,OAAvB,CAA+B,QAA/B,EAAyCC,GAAzC,CAA6C,UAAUC,OAAV,EAAmB;;AAEnF,4BAAMC,mBAAmBC,wBAAwBF,OAAxB,CAAzB;;AAEA,4BAAMG,MAAMN,EAAEO,IAAF,CAAOH,gBAAP,CAAZ;;AAEA,4BAAMI,SAAS,EAAEC,MAAMH,IAAIE,MAAZ,EAAoBE,cAAcJ,IAAIK,mBAAtC,EAAf;AACAH,+BAAOI,UAAP,GAAoBZ,EAAEI,gBAAF,EAAoBH,OAApB,CAA4B,WAA5B,EAAyCC,GAAzC,CAA6C,UAAUC,OAAV,EAAmB;AAChF,gCAAMG,MAAMN,EAAEO,IAAF,CAAOJ,OAAP,CAAZ;AACA,gCAAMU,YAAY,EAAEJ,MAAMH,IAAIO,SAAZ,EAAuBH,cAAcJ,IAAIQ,sBAAzC,EAAlB;AACAD,sCAAUE,WAAV,GAAwBf,EAAEE,GAAF,CAAMC,OAAN,EAAe,UAAUG,GAAV,EAAe;AAClDX,+CAAeqB,IAAf,CAAoBV,IAAIW,MAAxB;AACA,uCAAO;AACHA,4CAAQX,IAAIW,MADT;AAEHP,kDAAcJ,IAAII;AAFf,iCAAP;AAIH,6BANuB,CAAxB;AAOA,mCAAOG,SAAP;AACH,yBAXmB,EAWjBK,KAXiB,EAApB;AAYA,+BAAOV,MAAP;AACH,qBApBsB,EAoBpBU,KApBoB,EAAvB;AAqBAC,8BAAUC,kBAAkBlB,GAAlB,CAAsB,UAAUmB,CAAV,EAAa;AACzC,+BAAO;AACHX,0CAAcW,EAAEX,YADb;AAEHD,kCAAMY,EAAEZ,IAFL;AAGHG,wCAAYS,EAAET,UAAF,CAAaV,GAAb,CAAiB,UAAUoB,EAAV,EAAc;AACvC,uCAAO;AACHZ,kDAAcY,GAAGZ,YADd;AAEHK,iDAAaO,GAAGP,WAAH,CAAeQ,MAAf,CAAsB,UAAUC,GAAV,EAAe;AAC9C,+CAAO7B,eAAe8B,OAAf,CAAuBD,IAAIP,MAA3B,MAAuC,CAAC,CAA/C;AACH,qCAFY;AAFV,iCAAP;AAMH,6BAPW,EAOTM,MAPS,CAOF,UAAUD,EAAV,EAAc;AACpB,uCAAOA,GAAGP,WAAH,CAAeW,MAAf,KAA0B,CAAjC;AACH,6BATW;AAHT,yBAAP;AAcH,qBAfS,EAePH,MAfO,CAeA,UAAUF,CAAV,EAAa;AACnB,+BAAOA,EAAET,UAAF,CAAac,MAAb,KAAwB,CAA/B;AACH,qBAjBS,CAAV;;AAmBAP,8BAAU,4CAA0BA,OAA1B,CAAV;;AAEA,wBAAMJ,cAAc,sBAAE,WAAF,EAAeY,IAAf,CAAoB,cAApB,CAApB;AACAZ,gCAAYY,IAAZ,CAAiB,MAAjB,EAAyBC,MAAzB;AACAC,mCAAKC,WAAL,CAAiBf,WAAjB,EAA8BI,OAA9B,EAAuCY,eAAvC;AACH,iBAnDL;AAoDH,aAxDL,EAyDKC,KAzDL,CA0DQ,YAAM;AACF1C,4CACKC,MADL,CAEKG,IAFL,CAEU,EAAEC,gBAAgB,OAAlB,EAFV,EAGKF,IAHL,CAGU,UAAUG,IAAV,EAAgB;AAClBC,kCAAcC,GAAd,CAAkB,gBAAlB,EAAoCF,KAAKD,cAAzC;AACA,wBAAMA,iBAAiB,EAAvB;AACA,wBAAMI,iBAAiBC,EAAEJ,KAAKD,cAAP,EAAuBM,OAAvB,CAA+B,QAA/B,EAAyCC,GAAzC,CAA6C,UAAUC,OAAV,EAAmB;;AAEnF,4BAAMC,mBAAmBC,wBAAwBF,OAAxB,CAAzB;;AAEA,4BAAMG,MAAMN,EAAEO,IAAF,CAAOH,gBAAP,CAAZ;;AAEA,4BAAMI,SAAS,EAAEC,MAAMH,IAAIE,MAAZ,EAAoBE,cAAcJ,IAAIK,mBAAtC,EAAf;AACAH,+BAAOI,UAAP,GAAoBZ,EAAEI,gBAAF,EAAoBH,OAApB,CAA4B,WAA5B,EAAyCC,GAAzC,CAA6C,UAAUC,OAAV,EAAmB;AAChF,gCAAMG,MAAMN,EAAEO,IAAF,CAAOJ,OAAP,CAAZ;AACA,gCAAMU,YAAY,EAAEJ,MAAMH,IAAIO,SAAZ,EAAuBH,cAAcJ,IAAIQ,sBAAzC,EAAlB;AACAD,sCAAUE,WAAV,GAAwBf,EAAEE,GAAF,CAAMC,OAAN,EAAe,UAAUG,GAAV,EAAe;AAClDX,+CAAeqB,IAAf,CAAoBV,IAAIW,MAAxB;AACA,uCAAO;AACHA,4CAAQX,IAAIW,MADT;AAEHP,kDAAcJ,IAAII;AAFf,iCAAP;AAIH,6BANuB,CAAxB;AAOA,mCAAOG,SAAP;AACH,yBAXmB,EAWjBK,KAXiB,EAApB;AAYA,+BAAOV,MAAP;AACH,qBApBsB,EAoBpBU,KApBoB,EAAvB;AAqBAC,8BAAUC,kBAAkBlB,GAAlB,CAAsB,UAAUmB,CAAV,EAAa;AACzC,+BAAO;AACHX,0CAAcW,EAAEX,YADb;AAEHD,kCAAMY,EAAEZ,IAFL;AAGHG,wCAAYS,EAAET,UAAF,CAAaV,GAAb,CAAiB,UAAUoB,EAAV,EAAc;AACvC,uCAAO;AACHZ,kDAAcY,GAAGZ,YADd;AAEHK,iDAAaO,GAAGP,WAAH,CAAeQ,MAAf,CAAsB,UAAUC,GAAV,EAAe;AAC9C,+CAAO7B,eAAe8B,OAAf,CAAuBD,IAAIP,MAA3B,MAAuC,CAAC,CAA/C;AACH,qCAFY;AAFV,iCAAP;AAMH,6BAPW,EAOTM,MAPS,CAOF,UAAUD,EAAV,EAAc;AACpB,uCAAOA,GAAGP,WAAH,CAAeW,MAAf,KAA0B,CAAjC;AACH,6BATW;AAHT,yBAAP;AAcH,qBAfS,EAePH,MAfO,CAeA,UAAUF,CAAV,EAAa;AACnB,+BAAOA,EAAET,UAAF,CAAac,MAAb,KAAwB,CAA/B;AACH,qBAjBS,CAAV;;AAmBAP,8BAAU,4CAA0BA,OAA1B,CAAV;;AAEA,wBAAMJ,cAAc,sBAAE,WAAF,EAAeY,IAAf,CAAoB,cAApB,CAApB;AACAZ,gCAAYY,IAAZ,CAAiB,MAAjB,EAAyBC,MAAzB;AACAC,mCAAKC,WAAL,CAAiBf,WAAjB,EAA8BI,OAA9B,EAAuCY,eAAvC;AACH,iBAnDL;AAoDH,aA/GT;AAiHH,SAlHM,CAAP;AAmHH;;AAED,aAASA,eAAT,CAAyBd,MAAzB,EAAiCgB,WAAjC,EAA8C;AAC1CC,8BAAYC,YAAZ,CAAyB;AACrBC,4BAAgBnB,MADK;AAErBoB,4BAAgBJ,WAFK;AAGrBK,wBAAY,IAHS;AAIrBC,kBAAM;AAJe,SAAzB;AAMH;;AAED,QAAIpB,UAAU,EAAd;AACA,QAAIC,oBAAoB,EAAxB;;AAEO,QAAMoB,sBAAO,SAAPA,IAAO,GAAY;AAC5B,eAAOlD,4BACFC,MADE,CACKG,IADL,CACU,EAAE+C,eAAe,IAAIC,IAAJ,GAAWC,WAAX,GAAyBC,KAAzB,CAA+B,CAA/B,EAAkC,EAAlC,CAAjB,EADV,EAEFnD,IAFE,CAEG,UAAUG,IAAV,EAAgB;AAClBwB,gCAAoBS,eAAKgB,uBAAL,CAA6BjD,IAA7B,CAApB;AACAT;AACAG,wCAAQwD,MAAR,CAAeC,EAAf,CAAkB,OAAlB,EAA2B5D,sBAA3B;AACAG,wCAAQwD,MAAR,CAAeC,EAAf,CAAkB,QAAlB,EAA4B5D,sBAA5B;;AAEA,mBAAOiC,iBAAP;AACH,SATE,CAAP;AAUH,KAXM;;AAaA,QAAM4B,wCAAgB,SAAhBA,aAAgB,GAAY;AACrC,eAAO7B,OAAP;AACH,KAFM;;AAIA,QAAM8B,oDAAsB,SAAtBA,mBAAsB,CAAUC,qBAAV,EAAiCC,UAAjC,EAA6C;AAC5E,YAAIC,UAAU,KAAd;AACA,YAAI,CAACD,UAAL,EAAiB;AACbA,yBAAahC,OAAb;AACH;;AAED,YAAMkC,gBAAgB,IAAtB;AACAC,yBAAEC,IAAF,CAAOJ,UAAP,EAAmB,UAAUK,GAAV,EAAetC,KAAf,EAAsB;AACrC,gBAAIA,MAAMN,UAAN,IAAoBM,MAAMH,WAA9B,EAA2C;AACvCqC,0BAAUC,cAAcJ,mBAAd,CAAkCC,qBAAlC,EAAyDhC,MAAMN,UAAN,IAAoBM,MAAMH,WAAnF,CAAV;AACH,aAFD,MAEO;AACH,oBAAIuC,iBAAEG,IAAF,CAAOvC,MAAMR,YAAb,KAA8B4C,iBAAEG,IAAF,CAAOP,qBAAP,CAAlC,EAAiE;AAC7DE,8BAAU,IAAV;AACH;AACJ;AACD,mBAAO,CAACA,OAAR;AACH,SATD;AAUA,eAAOA,OAAP;AACH,KAlBM;;AAoBA,QAAMM,wDAAwB,SAAxBA,qBAAwB,CAAUR,qBAAV,EAAiCC,UAAjC,EAA6C;AAC9E,YAAIC,UAAU,EAAd;AACA,YAAI,CAACD,UAAL,EAAiB;AACbA,yBAAahC,OAAb;AACH;;AAED,YAAMkC,gBAAgB,IAAtB;AACAC,yBAAEC,IAAF,CAAOJ,UAAP,EAAmB,UAAUK,GAAV,EAAetC,KAAf,EAAsB;AACrC,gBAAIA,MAAMN,UAAN,IAAoBM,MAAMH,WAA9B,EAA2C;AACvCqC,0BAAUC,cAAcK,qBAAd,CAAoCR,qBAApC,EAA2DhC,MAAMN,UAAN,IAAoBM,MAAMH,WAArF,CAAV;AACH,aAFD,MAEO;AACH,oBAAIuC,iBAAEG,IAAF,CAAOvC,MAAMR,YAAb,KAA8B4C,iBAAEG,IAAF,CAAOP,qBAAP,CAAlC,EAAiE;AAC7DE,8BAAUlC,KAAV;AACH;AACJ;AACD,mBAAOoC,iBAAEK,aAAF,CAAgBP,OAAhB,CAAP;AACH,SATD;AAUA,eAAOA,OAAP;AACH,KAlBM;;sBAoBQ;AACXZ,kBADW;AAEXQ,oCAFW;AAGXC,gDAHW;AAIXS;AAJW,K","file":"instruments.js","sourcesContent":["import $ from \"jquery\";\nimport liveapi from \"websockets/binary_websockets\";\nimport menu from \"navigation/menu\";\nimport chartWindow from \"charts/chartWindow\";\nimport { getSortedMarketSubmarkets } from '../common/marketUtils';\nimport \"jquery-growl\";\nimport \"common/util\";\n\nfunction refresh_active_symbols() {\n    return new Promise((resolve) => {\n        liveapi\n            .cached\n            .authorize()\n            .then(() => {\n                liveapi\n                    .cached\n                    .send({ active_symbols: 'brief' })\n                    .then(function (data) {\n                        local_storage.set('active_symbols', data.active_symbols);\n                        const active_symbols = [];\n                        const active_markets = _(data.active_symbols).groupBy('market').map(function (symbols) {\n\n                            const filtered_symbols = filterRestrictedSymbols(symbols)\n\n                            const sym = _.head(filtered_symbols);\n\n                            const market = { name: sym.market, display_name: sym.market_display_name };\n                            market.submarkets = _(filtered_symbols).groupBy('submarket').map(function (symbols) {\n                                const sym = _.head(symbols);\n                                const submarket = { name: sym.submarket, display_name: sym.submarket_display_name };\n                                submarket.instruments = _.map(symbols, function (sym) {\n                                    active_symbols.push(sym.symbol);\n                                    return {\n                                        symbol: sym.symbol,\n                                        display_name: sym.display_name,\n                                    };\n                                });\n                                return submarket;\n                            }).value();\n                            return market;\n                        }).value();\n                        markets = chartable_markets.map(function (m) {\n                            return {\n                                display_name: m.display_name,\n                                name: m.name,\n                                submarkets: m.submarkets.map(function (sm) {\n                                    return {\n                                        display_name: sm.display_name,\n                                        instruments: sm.instruments.filter(function (ins) {\n                                            return active_symbols.indexOf(ins.symbol) !== -1;\n                                        })\n                                    }\n                                }).filter(function (sm) {\n                                    return sm.instruments.length !== 0;\n                                })\n                            }\n                        }).filter(function (m) {\n                            return m.submarkets.length !== 0;\n                        });\n\n                        markets = getSortedMarketSubmarkets(markets);\n\n                        const instruments = $(\"#nav-menu\").find(\".instruments\");\n                        instruments.find('> ul').remove();\n                        menu.refreshMenu(instruments, markets, onMenuItemClick);\n                    });\n            })\n            .catch(\n                () => {\n                    liveapi\n                        .cached\n                        .send({ active_symbols: 'brief' })\n                        .then(function (data) {\n                            local_storage.set('active_symbols', data.active_symbols);\n                            const active_symbols = [];\n                            const active_markets = _(data.active_symbols).groupBy('market').map(function (symbols) {\n\n                                const filtered_symbols = filterRestrictedSymbols(symbols)\n\n                                const sym = _.head(filtered_symbols);\n\n                                const market = { name: sym.market, display_name: sym.market_display_name };\n                                market.submarkets = _(filtered_symbols).groupBy('submarket').map(function (symbols) {\n                                    const sym = _.head(symbols);\n                                    const submarket = { name: sym.submarket, display_name: sym.submarket_display_name };\n                                    submarket.instruments = _.map(symbols, function (sym) {\n                                        active_symbols.push(sym.symbol);\n                                        return {\n                                            symbol: sym.symbol,\n                                            display_name: sym.display_name,\n                                        };\n                                    });\n                                    return submarket;\n                                }).value();\n                                return market;\n                            }).value();\n                            markets = chartable_markets.map(function (m) {\n                                return {\n                                    display_name: m.display_name,\n                                    name: m.name,\n                                    submarkets: m.submarkets.map(function (sm) {\n                                        return {\n                                            display_name: sm.display_name,\n                                            instruments: sm.instruments.filter(function (ins) {\n                                                return active_symbols.indexOf(ins.symbol) !== -1;\n                                            })\n                                        }\n                                    }).filter(function (sm) {\n                                        return sm.instruments.length !== 0;\n                                    })\n                                }\n                            }).filter(function (m) {\n                                return m.submarkets.length !== 0;\n                            });\n\n                            markets = getSortedMarketSubmarkets(markets);\n\n                            const instruments = $(\"#nav-menu\").find(\".instruments\");\n                            instruments.find('> ul').remove();\n                            menu.refreshMenu(instruments, markets, onMenuItemClick);\n                        });\n                }\n            );\n    });\n}\n\nfunction onMenuItemClick(symbol, displayName) {\n    chartWindow.addNewWindow({\n        instrumentCode: symbol,\n        instrumentName: displayName,\n        timePeriod: '1d',\n        type: 'candlestick'\n    });\n}\n\nlet markets = [];\nlet chartable_markets = [];\n\nexport const init = function () {\n    return liveapi\n        .cached.send({ trading_times: new Date().toISOString().slice(0, 10) })\n        .then(function (data) {\n            chartable_markets = menu.extractChartableMarkets(data);\n            refresh_active_symbols();\n            liveapi.events.on('login', refresh_active_symbols);\n            liveapi.events.on('logout', refresh_active_symbols);\n\n            return chartable_markets;\n        });\n}\n\nexport const getMarketData = function () {\n    return markets;\n}\n\nexport const isMarketDataPresent = function (marketDataDisplayName, marketData) {\n    let present = false;\n    if (!marketData) {\n        marketData = markets;\n    }\n\n    const instrumentObj = this;\n    $.each(marketData, function (key, value) {\n        if (value.submarkets || value.instruments) {\n            present = instrumentObj.isMarketDataPresent(marketDataDisplayName, value.submarkets || value.instruments);\n        } else {\n            if ($.trim(value.display_name) == $.trim(marketDataDisplayName)) {\n                present = true;\n            }\n        }\n        return !present;\n    });\n    return present;\n}\n\nexport const getSpecificMarketData = function (marketDataDisplayName, marketData) {\n    let present = {};\n    if (!marketData) {\n        marketData = markets;\n    }\n\n    const instrumentObj = this;\n    $.each(marketData, function (key, value) {\n        if (value.submarkets || value.instruments) {\n            present = instrumentObj.getSpecificMarketData(marketDataDisplayName, value.submarkets || value.instruments);\n        } else {\n            if ($.trim(value.display_name) == $.trim(marketDataDisplayName)) {\n                present = value;\n            }\n        }\n        return $.isEmptyObject(present);\n    });\n    return present;\n}\n\nexport default {\n    init,\n    getMarketData,\n    isMarketDataPresent,\n    getSpecificMarketData\n}\n"]}